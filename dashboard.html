<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNL System - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .welcome-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .welcome-card h1 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        
        .welcome-card p {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .user-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-info h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .user-info p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s ease;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .feature-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .feature-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9rem;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ */
        .upload-section, .categories-section, .rules-section {
            margin-top: 30px;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .upload-form {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .upload-btn, .primary-btn, .secondary-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .upload-btn {
            background: #007bff;
            color: white;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .primary-btn {
            background: #28a745;
            color: white;
        }

        .primary-btn:hover {
            background: #218838;
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .secondary-btn:hover {
            background: #545b62;
        }

        .upload-process-btn {
            background: #fd7e14;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
        }

        .upload-process-btn:hover:not(:disabled) {
            background: #e8690b;
        }

        .upload-process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-name {
            color: #666;
            font-style: italic;
        }

        .year-month-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .year-month-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .year-month-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .upload-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .upload-status.info {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .categories-controls, .rules-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .categories-list {
            margin-top: 20px;
        }

        .categories-type-group {
            margin-bottom: 20px;
        }

        .categories-type-group h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .category-item, .rule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .category-item.income {
            border-left: 4px solid #28a745;
        }

        .category-item.expense {
            border-left: 4px solid #dc3545;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .add-category-form {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .add-category-form h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .add-category-form input,
        .add-category-form select,
        .add-category-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .add-category-form textarea {
            height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
        }

        .rules-list {
            margin-top: 20px;
        }

        .rule-item {
            background: #fff;
            border: 1px solid #ddd;
        }

        .rule-pattern {
            font-family: monospace;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .rule-category {
            color: #666;
            margin-right: 10px;
        }

        .rule-stats {
            color: #999;
            font-size: 12px;
            margin-right: auto;
        }

        /* Results section styles */
        .results-section {
            margin-top: 30px;
        }

        .results-summary {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .results-summary h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .results-summary .summary-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 5px;
        }

        .results-summary .summary-value {
            font-weight: bold;
            color: #155724;
        }

        .results-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .operations-list-container {
            margin-top: 20px;
        }

        .operations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .operations-header h4 {
            color: #333;
            margin: 0;
        }

        .operations-count {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .operations-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .operation-item {
            display: grid;
            grid-template-columns: 120px 1fr 100px 80px 120px 150px 50px;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
            font-size: 14px;
        }

        .operation-item:last-child {
            border-bottom: none;
        }

        .operation-item:nth-child(even) {
            background: #f8f9fa;
        }

        .operation-header {
            background: #007bff;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .operation-date {
            font-family: monospace;
            font-size: 12px;
        }

        .operation-description {
            word-break: break-word;
        }

        .operation-amount {
            text-align: right;
            font-weight: bold;
        }

        .operation-amount.income {
            color: #28a745;
        }

        .operation-amount.expense {
            color: #dc3545;
        }

        .operation-currency {
            text-align: center;
            font-size: 12px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .operation-amount-pln {
            text-align: right;
            font-weight: bold;
            color: #495057;
        }

        .operation-category {
            text-align: center;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .operation-item.editable .operation-category {
            cursor: pointer;
            border: 1px dashed #007bff;
        }

        .operation-item.editable .operation-category:hover {
            background: #e3f2fd;
        }

        .category-edit-select {
            width: 100%;
            padding: 4px;
            border: 1px solid #007bff;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .category-edit-select:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .operation-actions {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .delete-operation-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }

        .delete-operation-btn:hover {
            background: #c82333;
        }

        .delete-operation-btn:active {
            background: #bd2130;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .logout-btn {
            padding: 15px 20px;
            border: none;
            background: #dc3545;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 0 8px 8px 0;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Full width sections */
        .section-card {
            width: 100%;
            max-width: none;
        }

        /* Grid layout for better space utilization */
        .main-content {
            display: grid;
            gap: 20px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* PNL Table Styles */
        .pnl-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pnl-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .pnl-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .pnl-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .pnl-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 800px;
        }

        .pnl-table th,
        .pnl-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e9ecef;
        }

        .pnl-table th {
            background: #495057;
            color: white;
            font-weight: 600;
            text-align: center;
        }

        .pnl-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .pnl-table tr:hover {
            background: #e3f2fd;
        }

        .pnl-table .category-row {
            font-weight: 500;
            background: #fff3cd !important;
        }

        .pnl-table .total-row {
            font-weight: bold;
            background: #d4edda !important;
        }

        .pnl-table .month-cell {
            text-align: center;
            min-width: 120px;
        }

        .pnl-table .editable-cell {
            cursor: pointer;
            position: relative;
        }

        .pnl-table .editable-cell:hover {
            background: #e8f5e8 !important;
        }

        .pnl-table .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 4px;
            font-size: inherit;
        }

        .pnl-analytics {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pnl-analytics h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .analytics-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .analytics-label {
            font-weight: 500;
            color: #495057;
        }

        .analytics-value {
            font-weight: bold;
            color: #28a745;
        }

        /* Marketing Section Styles */
        .marketing-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .marketing-section h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .marketing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .marketing-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .marketing-item label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .marketing-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .marketing-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .marketing-calculated {
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            font-size: 14px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .nav-tab {
                font-size: 14px;
                padding: 12px 15px;
            }
            .pnl-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="main">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-tab" data-tab="pnl">üìä P&L –¢–∞–±–ª–∏—Ü–∞</button>
            <button class="nav-tab" data-tab="categories">üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            <button class="nav-tab" data-tab="rules">üìè –ü—Ä–∞–≤–∏–ª–∞</button>
            <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>

        <!-- Main Tab Content -->
        <div class="tab-content active" id="main-tab">
            <div class="main-content">
                <!-- CSV Upload Section -->
                <div class="upload-section">
                    <div class="section-card">
                        <h3>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–æ–≤</h3>
                        <div class="upload-form">
                            <input type="file" id="csvFile" accept=".csv" style="display: none;">
                            <label for="csvFile" class="upload-btn">–í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª</label>
                            <span id="fileName" class="file-name"></span>
            </div>
            
                        <div class="year-month-selector" style="margin-top: 15px;">
                            <label>–ì–æ–¥: 
                                <select id="yearSelect">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2026">2026</option>
                                </select>
                            </label>
                            <label style="margin-left: 15px;">–ú–µ—Å—è—Ü: 
                                <select id="monthSelect">
                                    <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
                                    <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
                                    <option value="3">–ú–∞—Ä—Ç</option>
                                    <option value="4">–ê–ø—Ä–µ–ª—å</option>
                                    <option value="5">–ú–∞–π</option>
                                    <option value="6">–ò—é–Ω—å</option>
                                    <option value="7">–ò—é–ª—å</option>
                                    <option value="8">–ê–≤–≥—É—Å—Ç</option>
                                    <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
                                    <option value="10">–û–∫—Ç—è–±—Ä—å</option>
                                    <option value="11">–ù–æ—è–±—Ä—å</option>
                                    <option value="12">–î–µ–∫–∞–±—Ä—å</option>
                                </select>
                            </label>
        </div>
        
                        <button id="uploadBtn" class="upload-process-btn" style="margin-top: 15px;" disabled>
                            –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª
                        </button>
                        
                        <div id="uploadStatus" class="upload-status" style="display: none;"></div>
                    </div>
            </div>
            
                <!-- CSV Processing Results Section -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="section-card">
                        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV</h3>
                        <div class="results-summary" id="resultsSummary"></div>
                        
                        <div class="results-controls" style="margin: 20px 0;">
                            <button id="exportResultsBtn" class="secondary-btn">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
                            <button id="saveResultsBtn" class="primary-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∞–∑—É</button>
                            <button id="clearResultsBtn" class="secondary-btn">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            </div>
            
                        <div class="operations-list-container">
                            <div class="operations-header">
                                <h4>–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</h4>
                                <span id="operationsCount" class="operations-count"></span>
                            </div>
                            <div id="operationsList" class="operations-list">
                                <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                            </div>
                        </div>
                    </div>
            </div>
            
            </div>
        </div>

        <!-- PNL Tab Content -->
        <div class="tab-content" id="pnl-tab">
            <div class="section-card">
                <h3>üìä P&L –¢–∞–±–ª–∏—Ü–∞</h3>
                
                <!-- Year Selector -->
                <div class="pnl-controls">
                    <label>–ì–æ–¥: 
                        <select id="pnlYearSelect">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2026">2026</option>
                        </select>
                    </label>
                    <button id="loadPNLBtn" class="primary-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å P&L –¥–∞–Ω–Ω—ã–µ</button>
                    <button id="refreshPNLBtn" class="secondary-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                
                <!-- PNL Table -->
                <div id="pnlTableContainer" class="pnl-table-container">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å P&L –¥–∞–Ω–Ω—ã–µ"</p>
                </div>
                
                <!-- Marketing Metrics Section -->
                <div id="marketingSection" class="marketing-section" style="display: none;">
                    <h4>üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h4>
                    <div class="marketing-grid">
                        <div class="marketing-item">
                            <label>–õ–∏–¥—ã:</label>
                            <input type="number" id="leadsInput" placeholder="0" class="marketing-input">
                        </div>
                        <div class="marketing-item">
                            <label>–°–¥–µ–ª–∫–∏:</label>
                            <input type="number" id="dealsInput" placeholder="0" class="marketing-input">
                        </div>
                        <div class="marketing-item">
                            <label>–†–µ–∫–ª–∞–º–∞ (PLN):</label>
                            <input type="number" id="adSpendInput" placeholder="0" class="marketing-input">
                        </div>
                        <div class="marketing-item">
                            <label>–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%):</label>
                            <input type="number" id="conversionInput" placeholder="0" class="marketing-input">
                        </div>
                        <div class="marketing-item">
                            <label>–¶–µ–Ω–∞ –ª–∏–¥–∞ (PLN):</label>
                            <span id="costPerLead" class="marketing-calculated">0</span>
                        </div>
                        <div class="marketing-item">
                            <label>–¶–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ (PLN):</label>
                            <span id="costPerDeal" class="marketing-calculated">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Section -->
                <div id="pnlAnalytics" class="pnl-analytics" style="display: none;">
                    <h4>üìà –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h4>
                    <div class="analytics-grid">
                        <div class="analytics-item">
                            <span class="analytics-label">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫:</span>
                            <span id="totalProfitLoss" class="analytics-value">0 PLN</span>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ—à–ª–æ–º—É –º–µ—Å—è—Ü—É:</span>
                            <span id="balanceChange" class="analytics-value">0 PLN</span>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-label">ROI (%):</span>
                            <span id="roi" class="analytics-value">0%</span>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-label">–û–±–æ—Ä–æ—Ç–∫–∞ (–º–µ—Å):</span>
                            <span id="turnover" class="analytics-value">0</span>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-label">–ö—ç—à —Ñ–ª–æ—É:</span>
                            <span id="cashFlow" class="analytics-value">0 PLN</span>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-label">–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å (%):</span>
                            <span id="margin" class="analytics-value">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab Content -->
        <div class="tab-content" id="categories-tab">
            <div class="section-card">
                <h3>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h3>
                <div class="categories-controls">
                    <button id="loadCategoriesBtn" class="secondary-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
                    <button id="addCategoryBtn" class="primary-btn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                </div>
                
                <div id="categoriesList" class="categories-list">
                    <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                </div>
                
                <div id="addCategoryForm" class="add-category-form" style="display: none;">
                    <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                    <input type="text" id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
                    <select id="categoryType">
                        <option value="income">–î–æ—Ö–æ–¥—ã</option>
                        <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
                    </select>
                    <textarea id="categoryDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    <div class="form-actions">
                        <button id="saveCategoryBtn" class="primary-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button id="cancelCategoryBtn" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rules Tab Content -->
        <div class="tab-content" id="rules-tab">
            <div class="section-card">
                <h3>üìè –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
                <div class="rules-controls">
                    <button id="loadRulesBtn" class="secondary-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞</button>
                    <button id="addRuleBtn" class="primary-btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
                </div>
                
                <div id="rulesList" class="rules-list">
                    <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedFile = null;
        let categories = [];
        let rules = [];
        let currentResults = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        function isLocalhost() {
            return window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' ||
                   window.location.port === '3000';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function getAuthToken() {
            // –ù–∞ localhost –Ω–µ —Ç—Ä–µ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (isLocalhost()) {
                return null;
            }
            
            try {
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                return userData.token || null;
            } catch (e) {
                console.warn('Could not parse user data for auth token:', e);
                return null;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        function getAuthHeaders(additionalHeaders = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...additionalHeaders
            };
            
            // –ù–∞ localhost –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!isLocalhost()) {
                const token = getAuthToken();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
            } else {
                console.log('Localhost mode: skipping authorization header');
            }
            
            return headers;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        document.addEventListener('DOMContentLoaded', function() {
            const user = localStorage.getItem('user');
            
            // –ï—Å–ª–∏ —ç—Ç–æ localhost, —Å–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ—Ç
            if (isLocalhost()) {
                if (!user) {
                    const devUser = {
                        name: 'Developer',
                        email: 'dev@localhost.com',
                        picture: 'https://via.placeholder.com/40',
                        token: 'dev-token-localhost',
                        loginTime: new Date().toISOString()
                    };
                    localStorage.setItem('user', JSON.stringify(devUser));
                    console.log('–°–æ–∑–¥–∞–Ω —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è localhost:', devUser);
                }
            } else if (user) {
                // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                try {
                    const userData = JSON.parse(user);
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userEmail').textContent = userData.email;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    window.location.href = '/';
                }
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                window.location.href = '/';
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            initializeEventHandlers();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('monthSelect').value = currentMonth;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ P&L
            const currentYear = new Date().getFullYear();
            const pnlYearSelect = document.getElementById('pnlYearSelect');
            if (pnlYearSelect) {
                pnlYearSelect.value = currentYear;
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initializeEventHandlers() {
            // CSV —Ñ–∞–π–ª
            document.getElementById('csvFile').addEventListener('change', handleFileSelect);
            document.getElementById('uploadBtn').addEventListener('click', handleFileUpload);

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('loadCategoriesBtn').addEventListener('click', loadCategories);
            document.getElementById('addCategoryBtn').addEventListener('click', showAddCategoryForm);
            document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
            document.getElementById('cancelCategoryBtn').addEventListener('click', hideAddCategoryForm);

            // –ü—Ä–∞–≤–∏–ª–∞
            document.getElementById('loadRulesBtn').addEventListener('click', loadRules);

            // PNL Table
            document.getElementById('loadPNLBtn').addEventListener('click', loadPNLTable);
            document.getElementById('refreshPNLBtn').addEventListener('click', refreshPNLTable);

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CSV –æ–±—Ä–∞–±–æ—Ç–∫–∏
            document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
            document.getElementById('saveResultsBtn').addEventListener('click', saveResults);
            document.getElementById('clearResultsBtn').addEventListener('click', clearResults);

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('uploadBtn').disabled = false;
                showStatus('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: ' + file.name, 'success');
            } else {
                selectedFile = null;
                document.getElementById('fileName').textContent = '';
                document.getElementById('uploadBtn').disabled = true;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        async function handleFileUpload() {
            if (!selectedFile) {
                showStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                return;
            }

            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('year', year);
            formData.append('month', month);

            showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...', 'loading');
            document.getElementById('uploadBtn').disabled = true;

            try {
                const fetchOptions = {
                    method: 'POST',
                    body: formData
                };

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ localhost
                if (!isLocalhost()) {
                    const token = getAuthToken();
                    if (token) {
                        fetchOptions.headers = {
                            'Authorization': `Bearer ${token}`
                        };
                        console.log('Added Authorization header for CSV upload');
                    }
                } else {
                    console.log('Localhost mode: skipping authorization for CSV upload');
                }

                const response = await fetch('/api/csv/analyze-csv', fetchOptions);

                const result = await response.json();

                if (result.success) {
                    showStatus(`–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ! –û–ø–µ—Ä–∞—Ü–∏–π: ${result.operations?.length || 0}`, 'success');
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    displayProcessingResults(result);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:', result);
                } else {
                    showStatus('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...', 'loading');
            
            try {
                const headers = getAuthHeaders({ 'Content-Type': undefined }); // –£–±–∏—Ä–∞–µ–º Content-Type –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–∞
                delete headers['Content-Type']; // GET –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å Content-Type
                
                const response = await fetch('/api/categories', {
                    headers: headers
                });
                const result = await response.json();

                if (result.success) {
                    categories = result.categories || [];
                    displayCategories(categories);
                    showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${categories.length}`, 'success');
                } else {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + error.message, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function displayCategories(categories) {
            const container = document.getElementById('categoriesList');
            
            if (!categories || categories.length === 0) {
                container.innerHTML = '<p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            const incomeCategories = categories.filter(c => c.type === 'income');
            const expenseCategories = categories.filter(c => c.type === 'expense');

            container.innerHTML = `
                <div class="categories-type-group">
                    <h4>üí∞ –î–æ—Ö–æ–¥—ã (${incomeCategories.length})</h4>
                    ${incomeCategories.map(cat => `
                        <div class="category-item income">
                            <span>${cat.name}</span>
                            <button onclick="deleteCategory('${cat.id}')" class="delete-btn">‚úï</button>
                        </div>
                    `).join('')}
                </div>
                <div class="categories-type-group">
                    <h4>üí∏ –†–∞—Å—Ö–æ–¥—ã (${expenseCategories.length})</h4>
                    ${expenseCategories.map(cat => `
                        <div class="category-item expense">
                            <span>${cat.name}</span>
                            <button onclick="deleteCategory('${cat.id}')" class="delete-btn">‚úï</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const type = document.getElementById('categoryType').value;
            const description = document.getElementById('categoryDescription').value.trim();

            if (!name) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
                return;
            }

            showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...', 'loading');

            try {
                const response = await fetch('/api/categories', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        name,
                        type,
                        description: description || name
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                    hideAddCategoryForm();
                    loadCategories(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
                showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª
        async function loadRules() {
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª...', 'loading');
            
            try {
                const headers = getAuthHeaders({ 'Content-Type': undefined });
                delete headers['Content-Type'];
                
                const response = await fetch('/api/rules', {
                    headers: headers
                });
                const result = await response.json();

                if (result.success) {
                    rules = result.rules || [];
                    displayRules(rules);
                    showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∞–≤–∏–ª: ${rules.length}`, 'success');
                } else {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª: ' + error.message, 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
        function displayRules(rules) {
            const container = document.getElementById('rulesList');
            
            if (!rules || rules.length === 0) {
                container.innerHTML = '<p>–ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = rules.map(rule => `
                <div class="rule-item">
                    <div class="rule-pattern"><strong>${rule.pattern}</strong></div>
                    <div class="rule-category">‚Üí ${rule.categories?.name || 'Unknown'}</div>
                    <div class="rule-stats">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: ${rule.usage_count || 0}</div>
                    <button onclick="deleteRule('${rule.id}')" class="delete-btn">‚úï</button>
                </div>
            `).join('');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI
        function showAddCategoryForm() {
            document.getElementById('addCategoryForm').style.display = 'block';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryDescription').value = '';
        }

        function hideAddCategoryForm() {
            document.getElementById('addCategoryForm').style.display = 'none';
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = `upload-status ${type}`;
            statusEl.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏)
        async function deleteCategory(categoryId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) return;
            showStatus('–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...', 'loading');
            // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –≤—ã–∑–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            setTimeout(() => {
                showStatus('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞', 'info');
            }, 1000);
        }

        async function deleteRule(ruleId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ?')) return;
            showStatus('–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞...', 'loading');
            // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –≤—ã–∑–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            setTimeout(() => {
                showStatus('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞', 'info');
            }, 1000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            localStorage.removeItem('user');
            
            // –í—ã—Ö–æ–¥ –∏–∑ Google –∞–∫–∫–∞—É–Ω—Ç–∞
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.disableAutoSelect();
            }
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            window.location.href = '/';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV
        function displayProcessingResults(result) {
            currentResults = result;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('resultsSection').style.display = 'block';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≤–æ–¥–∫—É
            displayResultsSummary(result);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
            displayOperationsList(result.operations || []);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResultsSummary(result) {
            const summaryDiv = document.getElementById('resultsSummary');
            const summary = result.summary || {};
            
            summaryDiv.innerHTML = `
                <h4>–°–≤–æ–¥–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h4>
                <div class="summary-item">
                    <strong>–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π:</strong> 
                    <span class="summary-value">${summary.totalOperations || 0}</span>
                </div>
                <div class="summary-item">
                    <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞–ª—é—Ç—ã:</strong> 
                    <span class="summary-value">${(summary.currenciesFound || []).join(', ')}</span>
                </div>
                <div class="summary-item">
                    <strong>–û–±—â–∞—è —Å—É–º–º–∞ (PLN):</strong> 
                    <span class="summary-value">${summary.totalPLNAmount || 0}</span>
                </div>
                <div class="summary-item">
                    <strong>–ú–µ—Ç–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏:</strong> 
                    <span class="summary-value">${summary.categorizationMethod || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                </div>
                <div class="summary-item">
                    <strong>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç:</strong> 
                    <span class="summary-value">${summary.exchangeRates ? Object.entries(summary.exchangeRates).map(([curr, rate]) => `${curr}: ${rate}`).join(', ') : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</span>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
        function displayOperationsList(operations) {
            const operationsList = document.getElementById('operationsList');
            const operationsCount = document.getElementById('operationsCount');
            
            operationsCount.textContent = operations.length;
            
            if (operations.length === 0) {
                operationsList.innerHTML = '<p>–û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            const header = document.createElement('div');
            header.className = 'operation-item operation-header';
            header.innerHTML = `
                <div>–î–∞—Ç–∞</div>
                <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
                <div>–°—É–º–º–∞</div>
                <div>–í–∞–ª—é—Ç–∞</div>
                <div>–°—É–º–º–∞ (PLN)</div>
                <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                <div>–î–µ–π—Å—Ç–≤–∏—è</div>
            `;
            operationsList.innerHTML = '';
            operationsList.appendChild(header);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
            operations.forEach(operation => {
                const operationDiv = document.createElement('div');
                operationDiv.className = 'operation-item editable';
                
                const operationType = operation.operation_type || (operation.amount >= 0 ? 'income' : 'expense');
                const amountClass = operationType === 'income' ? 'income' : 'expense';
                const amountSign = operation.amount >= 0 ? '+' : '';
                
                operationDiv.innerHTML = `
                    <div class="operation-date">${operation.date || 'N/A'}</div>
                    <div class="operation-description">${operation.description || 'N/A'}</div>
                    <div class="operation-amount ${amountClass}">${amountSign}${operation.original_amount || operation.amount || 0}</div>
                    <div class="operation-currency">${operation.original_currency || operation.currency || 'N/A'}</div>
                    <div class="operation-amount-pln">${operation.amount_pln || 0} PLN</div>
                    <div class="operation-category" data-operation-index="${operations.indexOf(operation)}">${operation.category || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</div>
                    <div class="operation-actions">
                        <button class="delete-operation-btn" data-operation-index="${operations.indexOf(operation)}" title="–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é">üóëÔ∏è</button>
                    </div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –±–µ–∑ inline handler
                const categoryElement = operationDiv.querySelector('.operation-category');
                if (categoryElement) {
                    const operationIndex = operations.indexOf(operation);
                    categoryElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Category element clicked:', {
                            element: this,
                            operationIndex: operationIndex,
                            dataset: this.dataset
                        });
                        editOperationCategory(this, operationIndex);
                    });
                } else {
                    console.error('Category element not found for operation:', operations.indexOf(operation));
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                const deleteBtn = operationDiv.querySelector('.delete-operation-btn');
                if (deleteBtn) {
                    const operationIndex = operations.indexOf(operation);
                    deleteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Delete button clicked for operation:', operationIndex);
                        deleteOperation(operationIndex);
                    });
                } else {
                    console.error('Delete button not found for operation:', operations.indexOf(operation));
                }
                
                operationsList.appendChild(operationDiv);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
        function editOperationCategory(element, operationIndex) {
            console.log('editOperationCategory called:', {
                element: element,
                operationIndex: operationIndex,
                currentResults: !!currentResults,
                operations: currentResults?.operations?.length
            });
            
            if (!currentResults || !currentResults.operations || !currentResults.operations[operationIndex]) {
                console.error('Invalid data for category editing:', {
                    currentResults: !!currentResults,
                    operations: currentResults?.operations,
                    operationIndex: operationIndex
                });
                showStatus('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', 'error');
                return;
            }
            
            const operation = currentResults.operations[operationIndex];
            const availableCategories = currentResults.categories || {};
            const allCategories = [...(availableCategories.income || []), ...(availableCategories.expense || [])];
            
            console.log('Available categories:', allCategories);
            
            if (allCategories.length === 0) {
                showStatus('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (element.querySelector('select')) {
                console.log('Already in edit mode');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            const originalContent = element.innerHTML;
            
            // –°–æ–∑–¥–∞–µ–º —Å–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const select = document.createElement('select');
            select.className = 'category-edit-select';
            select.style.cssText = 'width: 100%; padding: 4px; border: 1px solid #007bff; border-radius: 4px;';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            if (!operation.category || operation.category === '') {
                noneOption.selected = true;
            }
            select.appendChild(noneOption);
            
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === operation.category) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Å–µ–ª–µ–∫—Ç
            element.innerHTML = '';
            element.appendChild(select);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const handleChange = function() {
                const newCategory = this.value;
                console.log('Category changed to:', newCategory, 'for operation index:', operationIndex);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                if (currentResults && currentResults.operations && currentResults.operations[operationIndex]) {
                    currentResults.operations[operationIndex].category = newCategory;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                element.innerHTML = newCategory || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';
                element.style.backgroundColor = newCategory ? '#e8f5e8' : '#fff3cd';
                
                showStatus(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${newCategory || '–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}`, 'success');
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –≤–Ω–µ —Å–µ–ª–µ–∫—Ç–∞)
            const handleBlur = function() {
                setTimeout(() => {
                    if (select.parentNode === element) {
                        handleChange.call(select);
                    }
                }, 200);
            };
            
            select.addEventListener('change', handleChange);
            select.addEventListener('blur', handleBlur);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Esc –¥–ª—è –æ—Ç–º–µ–Ω—ã
            const handleKeyDown = function(e) {
                if (e.key === 'Escape') {
                    element.innerHTML = originalContent;
                }
            };
            
            select.addEventListener('keydown', handleKeyDown);
            
            // –§–æ–∫—É—Å –Ω–∞ —Å–µ–ª–µ–∫—Ç
            select.focus();
            
            console.log('Category editing setup complete');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
        function deleteOperation(operationIndex) {
            if (!currentResults || !currentResults.operations) {
                showStatus('–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }

            if (operationIndex < 0 || operationIndex >= currentResults.operations.length) {
                showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å –æ–ø–µ—Ä–∞—Ü–∏–∏', 'error');
                return;
            }

            // –£–¥–∞–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∏–∑ –º–∞—Å—Å–∏–≤–∞ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            currentResults.operations.splice(operationIndex, 1);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
            displayOperationsList(currentResults.operations);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
            const operationsCount = document.getElementById('operationsCount');
            if (operationsCount) {
                operationsCount.textContent = `–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${currentResults.operations.length}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            displayResultsSummary(currentResults);
            
            showStatus(`–û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞. –û—Å—Ç–∞–ª–æ—Å—å –æ–ø–µ—Ä–∞—Ü–∏–π: ${currentResults.operations.length}`, 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function exportResults() {
            if (!currentResults) {
                showStatus('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `csv_results_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showStatus('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async function saveResults() {
            if (!currentResults) {
                showStatus('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            if (!currentResults.operations || currentResults.operations.length === 0) {
                showStatus('–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', 'loading');
            
            try {
                const payload = {
                    operations: currentResults.operations,
                    year: currentResults.year,
                    month: currentResults.month
                };
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
                const headers = getAuthHeaders();
                
                const response = await fetch('/api/csv/save-results', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.demo) {
                        showStatus(`üîÑ [–î–ï–ú–û –†–ï–ñ–ò–ú] ${result.message}`, 'info');
                    } else {
                        showStatus(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${result.operationsCount || currentResults.operations.length} –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö`, 'success');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º PNL —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    if (typeof loadPNLData === 'function') {
                        loadPNLData(currentResults.year, currentResults.month);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç–∞–∫ –∫–∞–∫ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ
                    if (typeof loadCategories === 'function') {
                        loadCategories();
                    }
                    
                    // –ú–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –¥–µ–º–æ)
                    // if (!result.demo) clearResults();
                } else {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
                    if (response.status === 409 && result.overwriteAvailable) {
                        showStatusWithOverwrite(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, result.error);
                    } else {
                        showStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                showStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
        function showStatusWithOverwrite(message, errorMessage) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.innerHTML = `
                <div style="color: #e74c3c; margin-bottom: 10px;">
                    ‚ö†Ô∏è ${message}
                </div>
                <button id="overwriteBtn" 
                        style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                </button>
            `;
            statusElement.style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
            const overwriteBtn = document.getElementById('overwriteBtn');
            if (overwriteBtn) {
                overwriteBtn.addEventListener('click', saveResultsWithOverwrite);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é
        async function saveResultsWithOverwrite() {
            if (!currentResults) {
                showStatus('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            if (!currentResults.operations || currentResults.operations.length === 0) {
                showStatus('–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            showStatus('–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ...', 'loading');
            
            try {
                const payload = {
                    operations: currentResults.operations,
                    year: currentResults.year,
                    month: currentResults.month,
                    overwrite: true // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
                };
                
                const headers = getAuthHeaders();
                
                const response = await fetch('/api/csv/save-results', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.demo) {
                        showStatus(`üîÑ [–î–ï–ú–û –†–ï–ñ–ò–ú] ${result.message}`, 'info');
                    } else {
                        showStatus(`‚úÖ –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ ${result.operationsCount || currentResults.operations.length} –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö`, 'success');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º PNL —Ç–∞–±–ª–∏—Ü—É
                    if (typeof loadPNLData === 'function') {
                        loadPNLData(currentResults.year, currentResults.month);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç–∞–∫ –∫–∞–∫ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ
                    if (typeof loadCategories === 'function') {
                        loadCategories();
                    }
                } else {
                    showStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏:', error);
                showStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function clearResults() {
            currentResults = null;
            document.getElementById('resultsSection').style.display = 'none';
            showStatus('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'success');
        }

        // PNL Table Functions
        async function loadPNLTable() {
            const year = document.getElementById('pnlYearSelect').value;
            if (!year) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ P&L –¥–∞–Ω–Ω—ã—Ö', 'error');
                return;
            }

            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ P&L –¥–∞–Ω–Ω—ã—Ö...', 'loading');

            try {
                const headers = getAuthHeaders();
                const response = await fetch(`/api/pnl?year=${year}`, {
                    method: 'GET',
                    headers: headers
                });

                const result = await response.json();

                if (result.success) {
                    displayPNLTable(result.data, year);
                    showStatus(`P&L –¥–∞–Ω–Ω—ã–µ –¥–ª—è ${year} –≥–æ–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, 'success');
                } else {
                    // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É
                    displayPNLTable(null, year);
                    showStatus(`P&L —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è ${year} –≥–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ (–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)`, 'info');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ P&L –¥–∞–Ω–Ω—ã—Ö:', error);
                // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É
                displayPNLTable(null, year);
                showStatus(`P&L —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö)`, 'info');
            }
        }

        async function refreshPNLTable() {
            showStatus('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ P&L –¥–∞–Ω–Ω—ã—Ö...', 'loading');
            await loadPNLTable();
        }

        // –§—É–Ω–∫—Ü–∏—è loadPNLData –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        async function loadPNLData(year, month) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ P&L —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ P&L
            const pnlTab = document.getElementById('pnl-tab');
            if (pnlTab && pnlTab.classList.contains('active')) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ P&L, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                document.getElementById('pnlYearSelect').value = year;
                await loadPNLTable();
            }
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ P&L, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º - –Ω–µ –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ–º
        }

        function displayPNLTable(pnlData, year) {
            const container = document.getElementById('pnlTableContainer');
            
            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
            if (!pnlData || !pnlData.categories || pnlData.categories.length === 0) {
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É —Å –±–∞–∑–æ–≤—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
                pnlData = {
                    categories: [
                        { name: 'Sales', type: 'income' },
                        { name: 'Consulting', type: 'income' },
                        { name: 'Marketing', type: 'expense' },
                        { name: 'Tools', type: 'expense' },
                        { name: 'Office', type: 'expense' }
                    ],
                    data: {}
                };
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const marketingCategories = [
                { name: '–õ–∏–¥—ã', type: 'marketing' },
                { name: '–°–¥–µ–ª–∫–∏', type: 'marketing' },
                { name: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)', type: 'marketing' },
                { name: '–¶–µ–Ω–∞ –ª–∏–¥–∞ (PLN)', type: 'marketing' },
                { name: '–¶–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ (PLN)', type: 'marketing' }
            ];

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const allCategories = [...pnlData.categories, ...marketingCategories];

            const months = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];

            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const incomeCategories = pnlData.categories.filter(cat => cat.type === 'income');
            const expenseCategories = pnlData.categories.filter(cat => cat.type === 'expense');

            let tableHTML = `
                <table class="pnl-table">
                    <thead>
                        <tr>
                            <th style="min-width: 200px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            ${months.map((month, index) => 
                                `<th class="month-cell">${month}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // –î–æ—Ö–æ–¥—ã
            if (incomeCategories.length > 0) {
                tableHTML += `<tr><td colspan="13" style="font-weight: bold; background: #e8f5e8;">üí∞ –î–û–•–û–î–´</td></tr>`;
                
                incomeCategories.forEach(category => {
                    tableHTML += `<tr class="category-row" data-category="${category.name}" data-type="income">`;
                    tableHTML += `<td style="padding-left: 20px;">${category.name}</td>`;
                    
                    for (let month = 1; month <= 12; month++) {
                        const amount = pnlData.data[category.name]?.[month] || 0;
                        tableHTML += `
                            <td class="month-cell editable-cell" 
                                data-category="${category.name}" 
                                data-month="${month}"
                                data-type="income">
                                ${amount > 0 ? amount.toFixed(2) : ''}
                            </td>
                        `;
                    }
                    tableHTML += '</tr>';
                });
            }

            // –†–∞—Å—Ö–æ–¥—ã
            if (expenseCategories.length > 0) {
                tableHTML += `<tr><td colspan="13" style="font-weight: bold; background: #ffeaa7;">üí∏ –†–ê–°–•–û–î–´</td></tr>`;
                
                expenseCategories.forEach(category => {
                    tableHTML += `<tr class="category-row" data-category="${category.name}" data-type="expense">`;
                    tableHTML += `<td style="padding-left: 20px;">${category.name}</td>`;
                    
                    for (let month = 1; month <= 12; month++) {
                        const amount = pnlData.data[category.name]?.[month] || 0;
                        tableHTML += `
                            <td class="month-cell editable-cell" 
                                data-category="${category.name}" 
                                data-month="${month}"
                                data-type="expense">
                                ${amount > 0 ? amount.toFixed(2) : ''}
                            </td>
                        `;
                    }
                    tableHTML += '</tr>';
                });
            }

            // –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            if (marketingCategories.length > 0) {
                tableHTML += `<tr><td colspan="13" style="font-weight: bold; background: #e3f2fd;">üìà –ú–ê–†–ö–ï–¢–ò–ù–ì–û–í–´–ï –ú–ï–¢–†–ò–ö–ò</td></tr>`;
                
                marketingCategories.forEach(category => {
                    tableHTML += `<tr class="category-row" data-category="${category.name}" data-type="marketing">`;
                    tableHTML += `<td style="padding-left: 20px;">${category.name}</td>`;
                    
                    for (let month = 1; month <= 12; month++) {
                        const amount = pnlData.data[category.name]?.[month] || 0;
                        tableHTML += `
                            <td class="month-cell editable-cell" 
                                data-category="${category.name}" 
                                data-month="${month}"
                                data-type="marketing">
                                ${amount > 0 ? amount.toFixed(2) : ''}
                            </td>
                        `;
                    }
                    tableHTML += '</tr>';
                });
            }

            // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            tableHTML += '<tr class="total-row"><td style="font-weight: bold;">–ò–¢–û–ì–û</td>';
            for (let month = 1; month <= 12; month++) {
                const incomeTotal = incomeCategories.reduce((sum, cat) => sum + (pnlData.data[cat.name]?.[month] || 0), 0);
                const expenseTotal = expenseCategories.reduce((sum, cat) => sum + (pnlData.data[cat.name]?.[month] || 0), 0);
                const total = incomeTotal - expenseTotal;
                
                tableHTML += `
                    <td class="month-cell" style="font-weight: bold; color: ${total >= 0 ? '#28a745' : '#dc3545'};">
                        ${total !== 0 ? total.toFixed(2) : ''}
                    </td>
                `;
            }
            tableHTML += '</tr>';

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫
            addCellEditHandlers();

            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –±–ª–æ–∫, —Ç–∞–∫ –∫–∞–∫ –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –≤ —Ç–∞–±–ª–∏—Ü–µ
            const marketingSection = document.getElementById('marketingSection');
            if (marketingSection) {
                marketingSection.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            const analyticsSection = document.getElementById('pnlAnalytics');
            if (analyticsSection) {
                analyticsSection.style.display = 'block';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            updatePNLAnalytics(pnlData);
        }

        function addCellEditHandlers() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const month = this.dataset.month;
                    const type = this.dataset.type;
                    const currentValue = this.textContent.trim();

                    // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ input
                    this.innerHTML = `<input type="number" value="${currentValue}" step="0.01">`;
                    const input = this.querySelector('input');
                    input.focus();
                    input.select();

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const saveEdit = async () => {
                        const newValue = parseFloat(input.value) || 0;
                        this.textContent = newValue > 0 ? newValue.toFixed(2) : '';
                        this.className = 'month-cell editable-cell';
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                        await savePNLCell(category, month, newValue, type);
                    };

                    const cancelEdit = () => {
                        this.textContent = currentValue;
                        this.className = 'month-cell editable-cell';
                    };

                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            saveEdit();
                        } else if (e.key === 'Escape') {
                            cancelEdit();
                        }
                    });
                });
            });
        }

        function setupMarketingCalculations() {
            const leadsInput = document.getElementById('leadsInput');
            const dealsInput = document.getElementById('dealsInput');
            const adSpendInput = document.getElementById('adSpendInput');
            const conversionInput = document.getElementById('conversionInput');
            const costPerLead = document.getElementById('costPerLead');
            const costPerDeal = document.getElementById('costPerDeal');

            function calculateMarketingMetrics() {
                const leads = parseFloat(leadsInput.value) || 0;
                const deals = parseFloat(dealsInput.value) || 0;
                const adSpend = parseFloat(adSpendInput.value) || 0;
                const conversion = parseFloat(conversionInput.value) || 0;

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏–¥—ã –∏ —Å–¥–µ–ª–∫–∏
                if (leads > 0 && deals > 0 && conversion === 0) {
                    const autoConversion = ((deals / leads) * 100).toFixed(1);
                    conversionInput.value = autoConversion;
                }

                // –¶–µ–Ω–∞ –ª–∏–¥–∞ = —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤
                const cpl = leads > 0 ? (adSpend / leads).toFixed(2) : '0.00';
                costPerLead.textContent = `${cpl} PLN`;

                // –¶–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ = —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫
                const cpd = deals > 0 ? (adSpend / deals).toFixed(2) : '0.00';
                costPerDeal.textContent = `${cpd} PLN`;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
            [leadsInput, dealsInput, adSpendInput, conversionInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', calculateMarketingMetrics);
                }
            });

            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
            calculateMarketingMetrics();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —è—á–µ–π–∫–∏ P&L –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async function savePNLCell(category, month, value, type) {
            try {
                const year = document.getElementById('yearSelector')?.value || new Date().getFullYear();
                
                const response = await fetch('/api/pnl/update-cell', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        category: category,
                        month: parseInt(month),
                        year: parseInt(year),
                        value: parseFloat(value),
                        type: type
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('PNL cell saved successfully:', result.data);
                    showStatus(`–Ø—á–µ–π–∫–∞ ${category} (${month} –º–µ—Å—è—Ü) –æ–±–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
                } else {
                    console.error('Error saving PNL cell:', result.error);
                    showStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error saving PNL cell:', error);
                showStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function updatePNLAnalytics(pnlData) {
            const analyticsDiv = document.getElementById('pnlAnalytics');
            analyticsDiv.style.display = 'block';

            // –†–∞—Å—á–µ—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            const currentMonth = new Date().getMonth() + 1;
            let currentIncome = 0;
            let currentExpense = 0;
            let previousIncome = 0;
            let previousExpense = 0;

            // –°—É–º–º–∏—Ä—É–µ–º –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            Object.keys(pnlData.data || {}).forEach(category => {
                const categoryData = pnlData.data[category];
                const categoryInfo = pnlData.categories.find(cat => cat.name === category);
                
                if (categoryInfo?.type === 'income') {
                    currentIncome += categoryData?.[currentMonth] || 0;
                    previousIncome += categoryData?.[currentMonth - 1] || 0;
                } else {
                    currentExpense += categoryData?.[currentMonth] || 0;
                    previousExpense += categoryData?.[currentMonth - 1] || 0;
                }
            });

            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            const currentProfitLoss = currentIncome - currentExpense;
            const previousProfitLoss = previousIncome - previousExpense;
            const balanceChange = currentProfitLoss - previousProfitLoss;
            
            // ROI = (–ü—Ä–∏–±—ã–ª—å / –î–æ—Ö–æ–¥—ã) * 100
            const roi = currentIncome > 0 ? ((currentProfitLoss / currentIncome) * 100).toFixed(1) : '0.0';
            
            // –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å = (–ü—Ä–∏–±—ã–ª—å / –î–æ—Ö–æ–¥—ã) * 100 (—Ç–æ –∂–µ —á—Ç–æ ROI)
            const margin = currentIncome > 0 ? ((currentProfitLoss / currentIncome) * 100).toFixed(1) : '0.0';
            
            // –û–±–æ—Ä–æ—Ç–∫–∞ = 12 / (–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã / –°—Ä–µ–¥–Ω–∏–µ –¥–æ—Ö–æ–¥—ã) - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
            const avgExpense = currentExpense;
            const avgIncome = currentIncome;
            const turnover = avgIncome > 0 && avgExpense > 0 ? (12 / (avgExpense / avgIncome)).toFixed(1) : '0';
            
            // –ö—ç—à —Ñ–ª–æ—É = –î–æ—Ö–æ–¥—ã - –†–∞—Å—Ö–æ–¥—ã (—Ç–æ –∂–µ —á—Ç–æ –ø—Ä–∏–±—ã–ª—å)
            const cashFlow = currentProfitLoss;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            document.getElementById('totalProfitLoss').textContent = `${currentProfitLoss.toFixed(2)} PLN`;
            document.getElementById('balanceChange').textContent = `${balanceChange.toFixed(2)} PLN`;
            document.getElementById('roi').textContent = `${roi}%`;
            document.getElementById('margin').textContent = `${margin}%`;
            document.getElementById('turnover').textContent = `${turnover} –º–µ—Å`;
            document.getElementById('cashFlow').textContent = `${cashFlow.toFixed(2)} PLN`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ P&L –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞
        async function loadPNLTableForCurrentYear() {
            const currentYear = new Date().getFullYear();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
            const yearSelect = document.getElementById('pnlYearSelect');
            if (yearSelect) {
                yearSelect.value = currentYear;
            }
            
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ P&L –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞...', 'loading');

            try {
                const headers = getAuthHeaders();
                const response = await fetch(`/api/pnl?year=${currentYear}`, {
                    method: 'GET',
                    headers: headers
                });

                const result = await response.json();
                
                if (result.success) {
                    displayPNLTable(result.data, currentYear);
                    showStatus(`P&L –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è ${currentYear} –≥–æ–¥–∞`, 'success');
                } else {
                    console.error('Error loading PNL data:', result.error);
                    showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ P&L –¥–∞–Ω–Ω—ã—Ö: ${result.error}`, 'error');
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    displayPNLTable(null, currentYear);
                }
            } catch (error) {
                console.error('Error loading PNL data:', error);
                showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ P&L –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                displayPNLTable(null, currentYear);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            const tabContentId = tabName === 'main' ? 'main-tab' : `${tabName}-tab`;
            document.getElementById(tabContentId).classList.add('active');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º P&L –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É P&L
            if (tabName === 'pnl') {
                loadPNLTableForCurrentYear();
            }
        }
    </script>
</body>
</html>


